<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gracy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        #output {
            margin-top: 20px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>Gracy</h1>
    <button id="start-btn">Start Listening</button>
    <div id="output">Waiting for audio input...</div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const outputDiv = document.getElementById('output');
        let recognition;

        // Check if the browser supports the Web Speech API
        if (!('webkitSpeechRecognition' in window) || !('speechSynthesis' in window)) {
            outputDiv.textContent = "Your browser does not support the Web Speech API.";
        } else {
            // Initialize the speech recognition object
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                outputDiv.textContent = "Listening...";
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                outputDiv.textContent = `Google Speech Recognition thinks you said: ${finalTranscript}`;
                sendQueryToGemini(finalTranscript);
            };

            recognition.onerror = function(event) {
                outputDiv.textContent = `Error occurred in recognition: ${event.error}`;
            };

            recognition.onend = function() {
                outputDiv.textContent = "Stopped listening.";
            };

            startBtn.addEventListener('click', function() {
                recognition.start();
            });

            // Function to send query to Gemini API
            async function sendQueryToGemini(query) {
                try {
                    const response = await fetch('https://gracys-generative-model.onrender.com//gemini', {  // Change this URL to your remote server if needed
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ query })
                    });
                    const data = await response.json();
                    outputDiv.textContent = `Gracy says: ${data.response}`;
                    speakText(data.response);
                } catch (error) {
                    outputDiv.textContent = `Error occurred: ${error.message}`;
                }
            }

            // Function to perform text-to-speech
            function speakText(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';

                const setVoiceAndSpeak = () => {
                    const voices = speechSynthesis.getVoices();
                    console.log('Available voices:', voices);

                    const femaleVoice = voices.find(voice => voice.name.includes('Female') || voice.name.includes('female') || voice.gender === 'female');
                    
                    if (femaleVoice) {
                        utterance.voice = femaleVoice;
                        console.log(`Using voice: ${femaleVoice.name}`);
                    } else {
                        console.log('Female voice not found, using default voice');
                    }

                    utterance.onstart = function() {
                        recognition.stop(); // Stop recognition while speaking
                    };
                    utterance.onend = function() {
                        recognition.start(); // Restart recognition after speaking
                    };
                    speechSynthesis.speak(utterance);
                };

                if (speechSynthesis.getVoices().length === 0) {
                    console.log('Voices not loaded yet, waiting for voiceschanged event');
                    speechSynthesis.onvoiceschanged = setVoiceAndSpeak;
                } else {
                    console.log('Voices already loaded');
                    setVoiceAndSpeak();
                }
            }
        }
    </script>
</body>
</html>
